stages:
  - security
  - deploy-operator
  - deploy-kafka
  - deploy-ui

variables:
  KAFKA_NAMESPACE: kafka
  SNYK_TOKEN: $SNYK_TOKEN

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "api"

snyk-iac-scan:
  stage: security
  image: node:20-alpine
  before_script:
    - npm install -g snyk
    - snyk --version
  script:
    - echo "Running Snyk IaC scan on Kubernetes manifests..."
    - snyk iac test manifests --severity-threshold=high --sarif-file-output=snyk-iac.sarif || true
    - echo "Snyk IaC scan completed"
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

snyk-container-scan:
  stage: security
  image: docker:latest
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  services:
    - docker:dind
  before_script:
    - apk add --no-cache npm
    - npm install -g snyk
    - snyk --version
  script:
    - echo "Running Snyk Container scan on CI images..."
    - snyk container test dtzar/helm-kubectl:latest --severity-threshold=high --sarif-file-output=snyk-container-helm.sarif || true
    - snyk container test alpine/git:latest --severity-threshold=high --sarif-file-output=snyk-container-git.sarif || true
    - snyk container test provectuslabs/kafka-ui:latest --severity-threshold=high --sarif-file-output=snyk-container-ui.sarif || true
    - echo "Snyk Container scans completed"
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

deploy-strimzi-operator:
  stage: deploy-operator
  image: dtzar/helm-kubectl:latest
  script:
    - echo "Installing Strimzi Operator..."
    - kubectl create namespace $KAFKA_NAMESPACE || true
    # Apply Strimzi install file directly from upstream
    - kubectl apply -f "https://strimzi.io/install/latest?namespace=$KAFKA_NAMESPACE" -n $KAFKA_NAMESPACE
    - echo "Waiting for Strimzi Operator..."
    - kubectl wait --for=condition=available --timeout=300s deployment/strimzi-cluster-operator -n $KAFKA_NAMESPACE
    - echo "Deploying Kafka Cluster..."
    - kubectl apply -f manifests/kafka/kafka-kraft.yaml -n $KAFKA_NAMESPACE
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

deploy-kafka-ui:
  stage: deploy-ui
  image: dtzar/helm-kubectl:latest
  script:
    - echo "Deploying Kafka UI..."
    - helm repo add kafka-ui https://provectus.github.io/kafka-ui-charts
    - helm repo update
    - helm upgrade --install kafka-ui kafka-ui/kafka-ui --namespace $KAFKA_NAMESPACE -f manifests/kafka/kafka-ui-values.yaml
    - echo "Applying Kafka UI Ingress..."
    - kubectl apply -f manifests/kafka/manual-ingress.yaml
    - echo "Kafka UI deployed successfully!"
    - kubectl get pods -n $KAFKA_NAMESPACE
  needs:
    - deploy-strimzi-operator
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

push-to-argocd:
  stage: deploy-ui
  image: alpine/git:latest
  before_script:
    - echo "Setting up SSH configuration..."
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # Check if SSH_PRIVATE_KEY is set
    - |
      if [ -z "$SSH_PRIVATE_KEY" ]; then
        echo "❌ SSH_PRIVATE_KEY variable is not set!"
        echo "Please configure SSH_PRIVATE_KEY in GitLab CI/CD variables"
        exit 1
      fi
    # Decode base64-encoded SSH key
    - echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - echo "SSH key file created with $(wc -l ~/.ssh/id_rsa) lines"
    - ssh-add ~/.ssh/id_rsa
    - ssh-keyscan -H gitlab-gitlab-shell.gitlab.svc.cluster.local >> ~/.ssh/known_hosts
    - git config --global user.email "ci@gitlab.local"
    - git config --global user.name "GitLab CI"
  script:
    - echo "Cloning argocd-project repository..."
    - git clone git@gitlab-gitlab-shell.gitlab.svc.cluster.local:root/argocd-project.git /tmp/argocd-project
    - cd /tmp/argocd-project
    - echo "Creating Kafka ArgoCD application manifest..."
    - |
      cat > kafka-application.yaml << EOF
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: kafka
        namespace: argocd
      spec:
        project: default
        source:
          repoURL: http://gitlab-webservice-default.gitlab.svc.cluster.local:8181/root/kafka-project.git
          targetRevision: HEAD
          path: manifests
        destination:
          server: https://kubernetes.default.svc
          namespace: kafka
        syncPolicy:
          automated:
            prune: true
            selfHeal: true
      EOF
    - echo "Adding and committing Kafka application manifest..."
    - git add kafka-application.yaml
    - git commit -m "Update Kafka application manifest" || echo "No changes to commit"
    - echo "Pushing to argocd-project repository..."
    - git push origin main
    - echo "✅ Kafka application successfully registered in ArgoCD!"
  after_script:
    - echo "Cleaning up SSH configuration..."
    - ssh-agent -k || true
    - rm -rf ~/.ssh
  needs:
    - deploy-kafka-ui
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"