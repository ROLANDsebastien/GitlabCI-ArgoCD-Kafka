stages:
  - deploy-operator
  - deploy-kafka
  - deploy-ui

variables:
  KAFKA_NAMESPACE: kafka

deploy-strimzi-operator:
  stage: deploy-operator
  image: dtzar/helm-kubectl:latest
  script:
    - echo "Installing Strimzi Operator..."
    - kubectl create namespace $KAFKA_NAMESPACE || true
    # Apply Strimzi install file directly from upstream
    - kubectl apply -f "https://strimzi.io/install/latest?namespace=$KAFKA_NAMESPACE" -n $KAFKA_NAMESPACE
    - echo "Waiting for Strimzi Operator..."
    - kubectl wait --for=condition=available --timeout=300s deployment/strimzi-cluster-operator -n $KAFKA_NAMESPACE
    - echo "Deploying Kafka Cluster..."
    - kubectl apply -f manifests/kafka/kafka-kraft.yaml -n $KAFKA_NAMESPACE
  only:
    - main
    - master

deploy-kafka-ui:
  stage: deploy-ui
  image: dtzar/helm-kubectl:latest
  script:
    - echo "Deploying Kafka UI..."
    - helm repo add kafka-ui https://provectus.github.io/kafka-ui-charts
    - helm repo update
    - helm upgrade --install kafka-ui kafka-ui/kafka-ui --namespace $KAFKA_NAMESPACE -f manifests/kafka/kafka-ui-values.yaml
    - echo "Applying Kafka UI Ingress..."
    - kubectl apply -f manifests/kafka/manual-ingress.yaml
    - echo "Kafka UI deployed successfully!"
    - kubectl get pods -n $KAFKA_NAMESPACE
  needs:
    - deploy-strimzi-operator
  only:
    - main
    - master

push-to-argocd:
  stage: deploy-ui
  image: alpine/git:latest
  script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - printf "%s" "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - wc -l ~/.ssh/id_rsa
    - ssh-add ~/.ssh/id_rsa
    - ssh-keyscan -H gitlab-gitlab-shell.gitlab.svc.cluster.local >> ~/.ssh/known_hosts
    - git config --global user.email "ci@gitlab.local"
    - git config --global user.name "GitLab CI"
    # Clone via internal service URL or configured DNS
    - git clone git@gitlab-gitlab-shell.gitlab.svc.cluster.local:root/argocd-project.git /tmp/argocd-project
    # Note: SSH usually stays on port 22 unless mapped otherwise, but here we are using HTTP for simplicity if possible.
    # Actually, the user's config used git@gitlab.local. 
    # Let's ensure gitlab.local resolves correctly for the runner.

    - cd /tmp/argocd-project
    - |
      cat > kafka-application.yaml << EOF
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: kafka
        namespace: argocd
      spec:
        project: default
        source:
          repoURL: git@gitlab-gitlab-shell.gitlab.svc.cluster.local:root/kafka-project.git
          targetRevision: HEAD
          path: manifests
        destination:
          server: https://kubernetes.default.svc
          namespace: kafka
        syncPolicy:
          automated:
            prune: true
            selfHeal: true
      EOF
    - git add kafka-application.yaml
    - git commit -m "Update Kafka application manifest" || echo "No changes to commit"
    - git push origin main
  needs:
    - deploy-kafka-ui
  only:
    - main
    - master